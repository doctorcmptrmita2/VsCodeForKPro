name: Build CodexFlow IDE

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.x'

jobs:
  build-windows:
    name: Build Windows Portable
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download VS Code Portable
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-archive" -OutFile "vscode-portable.zip" -UseBasicParsing
        shell: pwsh

      - name: Extract VS Code
        run: |
          Expand-Archive -Path "vscode-portable.zip" -DestinationPath "." -Force
          if (Test-Path "VSCode-win32-x64") {
            Rename-Item "VSCode-win32-x64" "CodexFlow-IDE"
          }
        shell: pwsh

      - name: Apply CodexFlow customizations
        run: |
          # Copy product.json
          Copy-Item "product.json" "CodexFlow-IDE\resources\app\product.json" -Force
          
          # Copy CodexFlow Agent extension
          if (Test-Path "extensions\codexflow-agent") {
            New-Item -ItemType Directory -Path "CodexFlow-IDE\resources\app\extensions\codexflow-agent" -Force | Out-Null
            Copy-Item "extensions\codexflow-agent\*" "CodexFlow-IDE\resources\app\extensions\codexflow-agent\" -Recurse -Force
          }
          
          # Copy CodexFlow Theme
          if (Test-Path "..\resources\app\extensions\codexflow-theme") {
            New-Item -ItemType Directory -Path "CodexFlow-IDE\resources\app\extensions\codexflow-theme" -Force | Out-Null
            Copy-Item "..\resources\app\extensions\codexflow-theme\*" "CodexFlow-IDE\resources\app\extensions\codexflow-theme\" -Recurse -Force
          }
          
          # Create data folder for portable mode
          New-Item -ItemType Directory -Path "CodexFlow-IDE\data" -Force | Out-Null
          
          Write-Host "CodexFlow customizations applied successfully!"
        shell: pwsh

      - name: Create ZIP archive
        run: |
          $Version = "1.108.0"
          Compress-Archive -Path "CodexFlow-IDE\*" -DestinationPath "CodexFlow-IDE-win32-x64-$Version.zip"
        shell: pwsh

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: codexflow-win32-x64
          path: CodexFlow-IDE-win32-x64-*.zip
          retention-days: 30

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: codexflow-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: CodexFlow IDE Build ${{ github.run_number }}
          draft: false
          prerelease: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
